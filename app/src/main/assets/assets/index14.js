import{T as R}from"./table-paginate.js";import{p as L}from"./table-paginate2.js";import{a as q,T as F}from"./dictionary.js";import{d as O,r as f,o as M,k as z,an as B,aq as K,ar as h,aw as d,ap as o,ax as w,a7 as I,a$ as V,aF as G,bo as E,bU as H,aS as J,h as $,l as W,C as X,ao as Y,as as x,au as Q,aC as Z,aD as ee}from"./index.js";import{_ as te}from"./Input.js";import{N as j}from"./DataTable.js";import{S as ae}from"./ShoppingOutlined.js";import{_ as le}from"./InputNumber.js";import{N as se}from"./Icon.js";import{_ as ne}from"./_plugin-vue_export-helper.js";import"./use-merged-state.js";import"./format-length.js";import"./Checkbox.js";import"./RadioGroup.js";import"./get-slot.js";import"./Dropdown.js";import"./use-compitable.js";import"./FocusDetector.js";import"./next-frame-once.js";import"./get.js";import"./ChevronRight.js";import"./Add.js";const oe=o("div",{class:"flex justify-between items-center w-full"},[o("h2",{class:"text-xl font-bold"},"添加其他耗材")],-1),ie={class:"grid grid-cols-5 gap-4 mb-4"},re={class:"flex items-center"},ue=o("span",{class:"mr-6"},"耗材子编码:",-1),ce={class:"flex items-center"},de=o("span",{class:"mr-4"},"耗材名称:",-1),pe={class:"flex items-center"},me=o("span",{class:"mr-4"},"规格型号:",-1),ve={class:"flex items-center"},ye=o("span",{class:"mr-4"},"生产厂家:",-1),fe={class:"flex items-center"},_e=o("span",{class:"mr-3"},"品牌:",-1),ge={class:"flex justify-end mb-4"},he={class:"flex justify-center mt-4"},be=O({__name:"dialog",props:{visible:{type:Boolean},rowData:{},parentTableData:{}},emits:["update:visible","submit","cancel","confirm"],setup(i,{emit:v}){const y=i,n=f({code:null,name:null,spec:null,manufacturer:null,brand:null});M(async()=>{c.value=[],p.value=[],await g()}),f({user:"",applicationNumber:"",applicationResults:"",type:"",listTime:"",items:[]});const c=f([]),C=r=>{c.value=r.map(e=>String(e));const l=s.value.filter(e=>c.value.includes(String(e.id))),t=p.value.filter(e=>!s.value.some(a=>String(a.id)===String(e.id)));p.value=[...t,...l]},S=f([{type:"selection",multiple:!0,disabled:r=>!1,options:["none","all"]},{title:"耗材子编码",key:"subCode"},{title:"耗材名称",key:"name"},{title:"规格型号",key:"specifiacation"},{title:"生产厂家",key:"manufacturer"},{title:"品牌",key:"brand"},{title:"单位",key:"unit"},{title:"销售包装规格",key:"sellPkgSpec"},{title:"销售包装单位",key:"sellPkgUnit"},{title:"销售包装数量",key:"sellPkgUnitNum"}]),s=f([]),g=async()=>{try{const r=await q({code:n.value.code,name:n.value.name,spec:n.value.spec,manufacturer:n.value.manufacturer,brand:n.value.brand,page:_.value.currentPage,pagesize:_.value.pageSize,type:F.Enable});if(r.error){s.value=[],_.value.totalItems=0;return}s.value=r.data.items.map(e=>({...e,id:String(e.id)})),_.value.totalItems=r.data.total;const l=s.value.map(e=>String(e.id));if(c.value.filter(e=>l.includes(e)).forEach(e=>{const a=s.value.find(u=>String(u.id)===e);a&&!p.value.some(u=>String(u.id)===e)&&p.value.push(a)}),y.parentTableData&&y.parentTableData.length>0){const e=y.parentTableData.map(a=>a.subCode||a.code).filter(Boolean);s.value.forEach(a=>{const u=a.subCode;if(u&&e.includes(u)){const k=String(a.id);c.value.includes(k)||(c.value.push(k),p.value.some(m=>String(m.id)===k)||p.value.push(a))}})}}catch(r){console.error("获取取用记录列表失败:",r),s.value=[],_.value.totalItems=0}},p=f([]),D=()=>{let r=[];p.value.length>0&&(r=p.value.map(l=>({id:l.id,code:l.subCode,name:l.name,spec:l.specifiacation,manufacturer:l.manufacturer,brand:l.brand,unit:l.unit,stock:l.stock||0,sellPkgUnitNum:l.sellPkgUnitNum||1,applyQuantity:1*l.sellPkgUnitNum||1}))),v("confirm",r),v("update:visible",!1),c.value=[],p.value=[]},T=()=>{n.value={code:null,name:null,spec:null,manufacturer:null,brand:null}},_=f({totalItems:100,pageSize:L,currentPage:1}),b=r=>{_.value.currentPage=r,g()},P=r=>({style:{cursor:"pointer"}});z(()=>y.visible,r=>{r?g():(c.value=[],p.value=[])});const N=()=>{v("update:visible",!1),v("cancel"),c.value=[],p.value=[]};return(r,l)=>{const t=te,e=I,a=j,u=V,k=G;return B(),K(k,{show:r.visible,"onUpdate:show":N,preset:"card",closable:"",style:{width:"fit-content"}},{header:h(()=>[oe]),default:h(()=>[d(u,null,{default:h(()=>[o("div",ie,[o("div",re,[ue,d(t,{value:n.value.code,"onUpdate:value":l[0]||(l[0]=m=>n.value.code=m),placeholder:"耗材子编码",style:{width:"120px"}},null,8,["value"])]),o("div",ce,[de,d(t,{value:n.value.name,"onUpdate:value":l[1]||(l[1]=m=>n.value.name=m),placeholder:"耗材名称",style:{width:"120px"}},null,8,["value"])]),o("div",pe,[me,d(t,{value:n.value.spec,"onUpdate:value":l[2]||(l[2]=m=>n.value.spec=m),placeholder:"规格型号",style:{width:"120px"}},null,8,["value"])]),o("div",ve,[ye,d(t,{value:n.value.manufacturer,"onUpdate:value":l[3]||(l[3]=m=>n.value.manufacturer=m),placeholder:"生产厂家",style:{width:"120px"}},null,8,["value"])]),o("div",fe,[_e,d(t,{value:n.value.brand,"onUpdate:value":l[4]||(l[4]=m=>n.value.brand=m),placeholder:"品牌",style:{width:"120px"}},null,8,["value"])])]),o("div",ge,[d(e,{onClick:T},{default:h(()=>[w("重置")]),_:1}),d(e,{type:"primary",style:{"margin-left":"10px"},onClick:g},{default:h(()=>[w("查询")]),_:1})]),d(a,{columns:S.value,"row-key":m=>String(m.id),"checked-row-keys":c.value,data:s.value,"onUpdate:checkedRowKeys":C,"default-checked-row-keys":c.value,"single-line":!1,"row-props":P},null,8,["columns","row-key","checked-row-keys","data","default-checked-row-keys"])]),_:1}),d(R,{total:_.value.totalItems,"page-size":_.value.pageSize,"current-page":_.value.currentPage,onPageChange:b},null,8,["total","page-size","current-page"]),o("div",he,[d(e,{type:"primary",onClick:D},{default:h(()=>[w("确定")]),_:1})])]),_:1},8,["show"])}}});function ke(i){var c;console.log("适配器收到的原始响应数据:",i);const v=((c=i==null?void 0:i.data)==null?void 0:c.data)||(i==null?void 0:i.data)||i;if(console.log("提取的actualData:",v),!v)return console.log("没有获取到有效数据，返回空数组"),{items:[]};let y;if(Array.isArray(v)?y=v:y=v.items,console.log("从actualData中提取的items:",y),!y||!Array.isArray(y))return console.log("items不存在或不是数组，返回空数组"),{items:[]};const n=y.map((C,S)=>{var s;return{index:S+1,key:((s=C.code)==null?void 0:s.toString())||String(S),...C}});return console.log("适配器处理后的数据:",{items:n}),{items:n}}const xe=async()=>{const i=await E.get("/api/apply/getInventoryConsumables");return H(ke,i)},we=async i=>await E.post("/api/apply/createApplyOrder",i),Ce=i=>(Z("data-v-e660e7c8"),i=i(),ee(),i),Se={class:"flex items-center mb-4"},Ie=Ce(()=>o("h2",{class:"text-xl font-bold"},"新建申领单",-1)),De={class:"table-container mt-4 relative"},Pe={class:"mb-4"},Te={class:"button-container absolute top-0 right-0"},Ne={class:"button-container mt-4 flex justify-end"},Ue=O({__name:"index",props:{selectedMaterial:{type:Object,default:()=>({})}},emits:["clear-stock"],setup(i,{emit:v}){const y=i,n=J(),c=f(!1),C=f({}),S=f([{title:"序号",key:"index",render:(t,e)=>e+1},{title:"耗材子编码",key:"code"},{title:"耗材名称",key:"name"},{title:"规格型号",key:"spec"},{title:"单位",key:"unit"},{title:"申领数量",key:"applyQuantity",render:t=>$(le,{value:t.applyQuantity,"onUpdate:value":e=>{const a=t.sellPkgUnitNum||1,u=e?Math.max(1,Math.round(e/a)*a):1;t.applyQuantity=u,b()},step:t.sellPkgUnitNum||1,min:1,controlsPosition:"both",style:"width: 100px;"})},{title:"操作",key:"actions",render(t){return $(I,{type:"primary",onClick:()=>N(t)},"移除")}}]),s=f([]),g=f({totalTypes:0,totalQuantity:0}),p=W(()=>{var t;return(t=n.userInfo)==null?void 0:t.userId});z(()=>y.selectedMaterial,t=>{t&&(Array.isArray(t)?t.forEach(e=>{D(e)}):D(t))},{immediate:!0});function D(t){s.value.some(a=>a.code===t.code)||(s.value.push({...t,applyQuantity:t.applyQuantity||1}),b())}M(()=>{b()}),X(()=>{v("clear-stock")});const T=async()=>{var t,e;try{const a=await xe();if(console.log("response:",a),a&&a.data&&Array.isArray(a.data)){if(a.data.length===0){(t=window.$message)==null||t.warning("暂无缺货耗材");return}l(a.data)}else(e=window.$message)==null||e.info("暂无缺货耗材")}catch(a){console.error("获取货柜数据失败:",a)}},_=()=>{c.value=!0};function b(){const t=s.value.length,e=s.value.reduce((a,u)=>a+Number(u.applyQuantity||0),0);g.value.totalTypes=t,g.value.totalQuantity=e}const P=()=>{s.value=[],b()};function N(t){s.value=s.value.filter(e=>(e.subCode||e.code)!==(t.subCode||t.code)),b()}const r=async()=>{var t,e,a,u;if(s.value.length===0){(t=window.$message)==null||t.warning("请先添加申领耗材");return}if(!p.value){(e=window.$message)==null||e.error("用户信息获取失败，请重新登录");return}try{const k={number:g.value.totalQuantity,suppliesList:s.value.map(A=>({code:A.subCode||A.code,num:Number(A.applyQuantity)||0})),type:"manual",userID:Number(p.value)},U=await we(k);(U==null?void 0:U.status)===200&&((a=window.$message)==null||a.success("提交成功"),P())}catch{(u=window.$message)==null||u.error("提交失败，请稍后重试")}},l=t=>{t.forEach(e=>{s.value.findIndex(u=>u.subCode===e.subCode&&u.name===e.name&&u.spec===e.spec&&u.unit===e.unit)!==-1||(e.applyQuantity===void 0&&(e.applyQuantity=1),s.value.push(e))}),b()};return(t,e)=>(B(),Y("div",null,[o("div",Se,[d(x(se),{component:x(ae),class:"text-2xl text-blue-600 mr-2"},null,8,["component"]),Ie]),o("div",De,[o("div",Pe,"申领耗材种类："+Q(g.value.totalTypes)+"种，总申领数： "+Q(g.value.totalQuantity),1),o("div",Te,[d(x(I),{type:"primary",onClick:T},{default:h(()=>[w("添加缺货耗材")]),_:1}),d(x(I),{type:"primary",style:{"margin-left":"10px"},onClick:_},{default:h(()=>[w("添加其他耗材")]),_:1})]),d(x(j),{columns:S.value,data:s.value},null,8,["columns","data"])]),o("div",Ne,[d(x(I),{onClick:P},{default:h(()=>[w("清空申领单")]),_:1}),d(x(I),{type:"primary",style:{"margin-left":"10px"},onClick:r},{default:h(()=>[w("提交申领单")]),_:1})]),d(be,{visible:c.value,rowData:C.value,parentTableData:s.value,"onUpdate:visible":e[0]||(e[0]=a=>c.value=a),onCancel:e[1]||(e[1]=a=>c.value=!1),onConfirm:l},null,8,["visible","rowData","parentTableData"])]))}});const et=ne(Ue,[["__scopeId","data-v-e660e7c8"]]);export{et as default};
