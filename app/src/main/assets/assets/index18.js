import{T as G}from"./table-paginate.js";import{f as oe}from"./dictionary.js";import{p as H}from"./table-paginate2.js";import{d as q,r as c,bb as K,o as J,k as re,C as se,an as L,aq as R,ar as t,aw as a,ap as I,as as y,a7 as k,ax as g,au as B,be as ie,bf as ue,a$ as Q,aF as X,aB as O,bg as ce,bh as de,bi as pe,bj as F,ao as me,bk as _e,bl as fe,aC as ve,aD as ge,h as M,bm as ye}from"./index.js";import{_ as be,D as he,A as xe,a as ke,i as we}from"./DocumentAttachOutline.js";import{_ as De}from"./Input.js";import{_ as Y}from"./FormItem.js";import{N as Z,a as ee}from"./Grid.js";import{_ as ae}from"./Form.js";import{N as te}from"./DataTable.js";import{_ as Ce,a as Se}from"./DescriptionsItem.js";import{_ as Te}from"./InputNumber.js";import{S as Pe}from"./Settings.js";import{a as ze}from"./Dropdown.js";import{N as Ie}from"./Icon.js";import{_ as We}from"./_plugin-vue_export-helper.js";import"./use-merged-state.js";import"./format-length.js";import"./get.js";import"./next-frame-once.js";import"./get-slot.js";import"./Checkbox.js";import"./RadioGroup.js";import"./FocusDetector.js";import"./ChevronRight.js";import"./use-compitable.js";import"./Add.js";const Ne={class:"flex justify-end gap-2"},Ae=q({__name:"add-consumable-dialog",props:{parentTableData:{}},emits:["confirm"],setup(z,{expose:_,emit:W}){const d=z,h=c(!1),f=c([]),l=c([]),u=c({totalItems:100,pageSize:H,currentPage:1}),C=c(!1),w=K(),x=c([]);function p(){return[{type:"selection",fixed:"left",multiple:!0,disabled:s=>!1,options:["none","all"]},{title:"耗材子编码",key:"subCode"},{title:"耗材名称",key:"name"},{title:"规格型号",key:"specifiacation"},{title:"生产厂家",key:"manufacturer"},{title:"品牌",key:"brand"},{title:"单位",key:"unit"}]}const r=p(),P=()=>{h.value=!0,S()};J(()=>{});const v=c({code:"",name:"",spec:"",brand:"",manufacturer:""}),$=s=>{f.value=s.map(e=>String(e));const o=x.value.filter(e=>f.value.includes(String(e.id))),i=l.value.filter(e=>!x.value.some(n=>String(n.id)===String(e.id)));l.value=[...i,...o]},N=async()=>{try{if(l.value.length===0){w.error("请至少选择一项耗材");return}const s=l.value.map(i=>({id:i.id,code:i.subCode,name:i.name,spec:i.specifiacation,manufacturer:i.manufacturer,brand:i.brand,unit:i.unit,expiryWarningTime:null})),{error:o}=await ie({list:s});if(o){w.error("添加效期预警耗材失败: "+o);return}w.success("添加成功"),h.value=!1,f.value=[],l.value=[],W("confirm")}catch(s){console.error("添加效期预警耗材失败:",s),w.error("添加效期预警耗材失败: "+(s instanceof Error?s.message:"未知错误"))}},U=()=>{v.value={code:"",name:"",spec:"",brand:"",manufacturer:""},S()},S=async()=>{try{const{data:s,error:o}=await oe({...v.value,page:u.value.currentPage,pagesize:u.value.pageSize,type:ue.Enable});if(o){w.error("获取所有耗材字典列表失败: "+o);return}if(s){x.value=s.items.map(n=>({...n,id:String(n.id)})),u.value.totalItems=s.total;const i=x.value.map(n=>String(n.id));if(f.value.filter(n=>i.includes(n)).forEach(n=>{const m=x.value.find(D=>String(D.id)===n);m&&!l.value.some(D=>String(D.id)===n)&&l.value.push(m)}),d.parentTableData&&d.parentTableData.length>0){const n=d.parentTableData.map(m=>m.code||m.subCode).filter(Boolean);x.value.forEach(m=>{const D=m.subCode;if(D&&n.includes(D)){const T=String(m.id);f.value.includes(T)||(f.value.push(T),l.value.some(j=>String(j.id)===T)||l.value.push(m))}})}}}catch(s){console.error("加载耗材数据失败:",s),w.error("加载耗材数据失败")}finally{C.value=!1}},E=async()=>{u.value.currentPage=1,await S()};async function A(s){u.value.currentPage=s,await S()}const V=s=>({style:{cursor:"pointer"}});return re(()=>h.value,s=>{s?S():(f.value=[],l.value=[])}),se(()=>{f.value=[],l.value=[],v.value={code:"",name:"",spec:"",brand:"",manufacturer:""}}),_({open:P}),(s,o)=>{const i=De,e=Y,n=Z,m=ee,D=ae,T=be,j=te,ne=Q,le=X;return L(),R(le,{show:h.value,"onUpdate:show":o[6]||(o[6]=b=>h.value=b)},{default:t(()=>[a(ne,{style:{width:"80vw","max-width":"1200px"},title:"添加耗材",bordered:!1},{footer:t(()=>[I("div",Ne,[a(y(k),{onClick:o[5]||(o[5]=b=>h.value=!1)},{default:t(()=>[g("取消")]),_:1}),a(y(k),{type:"primary",onClick:N},{default:t(()=>[g("确定")]),_:1})])]),default:t(()=>[a(D,{model:v.value,"label-placement":"left","label-width":"auto"},{default:t(()=>[a(m,{cols:24,"x-gap":24},{default:t(()=>[a(n,{span:8},{default:t(()=>[a(e,{label:"耗材子编码"},{default:t(()=>[a(i,{value:v.value.code,"onUpdate:value":o[0]||(o[0]=b=>v.value.code=b)},null,8,["value"])]),_:1})]),_:1}),a(n,{span:8},{default:t(()=>[a(e,{label:"耗材名称"},{default:t(()=>[a(i,{value:v.value.name,"onUpdate:value":o[1]||(o[1]=b=>v.value.name=b)},null,8,["value"])]),_:1})]),_:1}),a(n,{span:8},{default:t(()=>[a(e,{label:"规格型号"},{default:t(()=>[a(i,{value:v.value.spec,"onUpdate:value":o[2]||(o[2]=b=>v.value.spec=b)},null,8,["value"])]),_:1})]),_:1}),a(n,{span:8},{default:t(()=>[a(e,{label:"品牌"},{default:t(()=>[a(i,{value:v.value.brand,"onUpdate:value":o[3]||(o[3]=b=>v.value.brand=b)},null,8,["value"])]),_:1})]),_:1}),a(n,{span:8},{default:t(()=>[a(e,{label:"生产厂家"},{default:t(()=>[a(i,{value:v.value.manufacturer,"onUpdate:value":o[4]||(o[4]=b=>v.value.manufacturer=b)},null,8,["value"])]),_:1})]),_:1}),a(n,{span:8,class:"flex items-center"},{default:t(()=>[a(y(k),{type:"primary",onClick:E},{default:t(()=>[g("查询")]),_:1}),a(y(k),{class:"ml-4",onClick:U},{default:t(()=>[g("重置")]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),a(T,{class:"mb-4"},{default:t(()=>[g("已选中 "+B(l.value.length)+" 项耗材",1)]),_:1}),a(j,{columns:y(r),data:x.value,"row-key":b=>String(b.id),"checked-row-keys":f.value,"onUpdate:checkedRowKeys":$,"default-checked-row-keys":f.value,loading:C.value,"row-props":V},null,8,["columns","data","row-key","checked-row-keys","default-checked-row-keys","loading"]),a(G,{total:u.value.totalItems,"page-size":u.value.pageSize,"current-page":u.value.currentPage,onPageChange:A},null,8,["total","page-size","current-page"])]),_:1})]),_:1},8,["show"])}}}),$e=I("span",{style:{color:"red"}},"注:效期预警天数不能为负",-1),Ue={class:"flex justify-end gap-2"},Ee=q({__name:"editorDialog",emits:["confirm"],setup(z,{expose:_,emit:W}){const d=K(),h=c(),f=c(!1),l=c({idList:0,expiryAlertDays:0}),u=c({}),C=c(""),w=(p,r)=>{C.value=p==="batch"?"批量编辑耗材效期预警":" 耗材效期预警设置",h.value=p,r&&p==="edit"?(l.value={...r},l.value.expiryAlertDays=Number(r.expiryWarningTime)||0,u.value={...r}):r&&p==="batch"&&(l.value.idList=r,l.value.expiryAlertDays=30),f.value=!0},x=async()=>{if(!l.value.expiryAlertDays||l.value.expiryAlertDays<=0){d.error("请输入有效的效期预警时间");return}try{if(!Array.isArray(l.value.idList)){const p={id:String(u.value.id),code:u.value.code||u.value.subCode||"",expiryWarningTime:String(l.value.expiryAlertDays)};await ce(p),d.success("更新耗材效期预警设置成功")}W("confirm"),f.value=!1}catch(p){console.error("保存效期预警设置失败:",p),d.error("保存失败，请重试")}};return _({open:w}),(p,r)=>{const P=Ce,v=Se,$=Te,N=Y,U=Z,S=ee,E=ae,A=k,V=Q,s=X;return L(),R(s,{show:f.value,"onUpdate:show":r[2]||(r[2]=o=>f.value=o),title:C.value,preset:"card",style:{width:"650px"}},{default:t(()=>[a(V,{style:{width:"600px"},bordered:!1},{footer:t(()=>[I("div",Ue,[a(A,{onClick:r[1]||(r[1]=o=>f.value=!1)},{default:t(()=>[g("取消")]),_:1}),a(A,{type:"primary",onClick:x},{default:t(()=>[g("确定")]),_:1})])]),default:t(()=>[h.value==="edit"?(L(),R(v,{key:0,"label-placement":"left",column:2,class:"mb-4 pl-10"},{default:t(()=>[a(P,{label:"耗材名称"},{default:t(()=>[g(B(u.value.name),1)]),_:1}),a(P,{label:"耗材子编码"},{default:t(()=>[g(B(u.value.code),1)]),_:1}),a(P,{label:"规格型号"},{default:t(()=>[g(B(u.value.spec),1)]),_:1}),a(P,{label:"品牌"},{default:t(()=>[g(B(u.value.brand),1)]),_:1})]),_:1})):O("",!0),a(E,{model:l.value,"label-placement":"left","label-width":"120px"},{default:t(()=>[a(S,{cols:2,"x-gap":24,"item-responsive":!0},{default:t(()=>[a(U,{span:1},{default:t(()=>[a(N,{label:"效期预警时间："},{default:t(()=>[a($,{value:l.value.expiryAlertDays,"onUpdate:value":r[0]||(r[0]=o=>l.value.expiryAlertDays=o),min:0,clearable:""},{suffix:t(()=>[g(" 天 ")]),_:1},8,["value"])]),_:1}),$e]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1},8,["show","title"])}}}),Ve=z=>(ve("data-v-1b545d24"),z=z(),ge(),z),Be={class:"inventory-setting"},Le={class:"mb-4 flex items-center",style:{"font-size":"22px"}},Re={class:"mb-4 flex items-center gap-4"},je=Ve(()=>I("label",null,"缺省预警时间设置：",-1)),Me={class:"toolbar mb-4 flex gap-2 justify-end"},Oe=q({__name:"index",setup(z){const _=c({totalItems:100,pageSize:H,currentPage:1}),W=c(),d=K(),h=de(),f=c([{label:"30天",value:30},{label:"60天",value:60},{label:"90天",value:90},{label:"180天",value:180}]),l=c(60),u=c(!1),C=c(60);function w(e){l.value=e,u.value=e!==C.value}async function x(){try{await _e({expiryWarningDefaultValue:l.value})&&(d.success("默认预警时间设置成功"),C.value=l.value,u.value=!1)}catch(e){console.error("更新默认预警时间失败:",e),d.error("更新默认预警时间失败")}}const p=c([]),r=c([]);J(async()=>{try{const e=await pe();e.data&&e.data.expiryWarningDefaultValue&&(l.value=e.data.expiryWarningDefaultValue,C.value=e.data.expiryWarningDefaultValue);const n=await F({page:_.value.currentPage,pagesize:_.value.pageSize});n.data&&n.data.items?(p.value=n.data.items.map(m=>({...m,expiryWarningTime:m.expiryWarningTime||l.value})),_.value={totalItems:n.data.total,pageSize:n.data.pagesize,currentPage:n.data.page}):(p.value=[],_.value={totalItems:0,pageSize:_.value.pageSize,currentPage:1})}catch(e){console.error("获取数据失败:",e),d.error("获取数据失败"),p.value=[]}});function P(){return[{type:"selection",fixed:"left"},{title:"序号",key:"index",render:(e,n)=>n+1},{title:"耗材子编码",key:"code"},{title:"耗材名称",key:"name"},{title:"规格型号",key:"spec"},{title:"生产厂家",key:"manufacturer"},{title:"品牌",key:"brand"},{title:"单位",key:"unit"},{title:"效期预警时间（天）",key:"expiryWarningTime"},{title:"操作",key:"actions",render:e=>M("div",{class:"flex gap-2"},[M(k,{text:!0,type:"primary",onClick:()=>{var n;return(n=W.value)==null?void 0:n.open("edit",e)}},{default:()=>"编辑"}),M(k,{text:!0,type:"error",onClick:()=>A(e)},{default:()=>"删除"})])}]}const v=async()=>{try{const{data:e,error:n}=await we({targetModel:"expire"});if(n){d.error("导入失败: "+n);return}e&&(d.success("导入成功"),i())}catch(e){console.error("导入耗材字典失败:",e),d.error("导入耗材字典失败")}},$=()=>{var e;(e=N.value)==null||e.open()},N=c(),U=P(),S=async()=>{await i()},E=()=>{if(r.value.length===0){d.warning("请先选择要删除的记录");return}h.warning({title:"警告",content:`是否确认不再监测这 ${r.value.length} 个耗材？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{await fe(r.value),d.success("批量删除成功！"),await i(),r.value=[]}catch(e){console.error("批量删除失败:",e),d.error("批量删除失败")}},onNegativeClick:()=>{}})},A=e=>{h.warning({title:"警告",content:`是否确认不再监测 ${e.name} 耗材？`,positiveText:"确定",negativeText:"取消",onPositiveClick:async()=>{try{await ye({ID:e.id}),d.success("删除成功！"),await i()}catch(n){console.error("删除失败:",n),d.error("删除失败")}},onNegativeClick:()=>{}})},V=e=>{r.value=e},s=async()=>{await i(),r.value=[]},o=async e=>{_.value.currentPage=e,await i()},i=async()=>{try{r.value=[];const e=await F({page:_.value.currentPage,pagesize:_.value.pageSize});e.data&&e.data.items?(p.value=e.data.items.map(n=>({...n,expiryWarningTime:n.expiryWarningTime||l.value})),_.value={totalItems:e.data.total,pageSize:e.data.pagesize,currentPage:e.data.page}):(p.value=[],_.value={totalItems:0,pageSize:_.value.pageSize,currentPage:1})}catch(e){console.error("获取数据失败:",e),d.error("获取数据失败"),p.value=[]}};return(e,n)=>{const m=Ie,D=te;return L(),me("div",Be,[I("div",Le,[a(m,null,{default:t(()=>[a(y(Pe))]),_:1}),g("耗材效期预警设置 ")]),I("div",Re,[je,a(y(ze),{style:{width:"200px"},value:l.value,"onUpdate:value":[n[0]||(n[0]=T=>l.value=T),w],options:f.value},null,8,["value","options"]),u.value?(L(),R(y(k),{key:0,type:"primary",onClick:x,class:"mt-1"},{default:t(()=>[g(" 确定 ")]),_:1})):O("",!0)]),I("div",Me,[a(y(k),{type:"primary",onClick:v},{icon:t(()=>[a(m,null,{default:t(()=>[a(y(he))]),_:1})]),default:t(()=>[g(" 从本地耗材字典导入 ")]),_:1}),a(y(k),{type:"primary",onClick:$},{icon:t(()=>[a(m,null,{default:t(()=>[a(y(xe))]),_:1})]),default:t(()=>[g(" 添加 ")]),_:1}),O("",!0),a(y(k),{type:"error",onClick:E},{icon:t(()=>[a(m,null,{default:t(()=>[a(y(ke))]),_:1})]),default:t(()=>[g(" 批量删除 ")]),_:1})]),a(D,{columns:y(U),data:p.value,"row-key":T=>T.id,"checked-row-keys":r.value,"onUpdate:checkedRowKeys":V},null,8,["columns","data","row-key","checked-row-keys"]),a(G,{total:_.value.totalItems,"page-size":_.value.pageSize,"current-page":_.value.currentPage,onPageChange:o},null,8,["total","page-size","current-page"]),a(Ae,{ref_key:"addDialog",ref:N,parentTableData:p.value,onConfirm:S},null,8,["parentTableData"]),a(Ee,{ref_key:"editorDialog",ref:W,onConfirm:s},null,512)])}}});const ga=We(Oe,[["__scopeId","data-v-1b545d24"]]);export{ga as default};
