import{T as W}from"./table-paginate.js";import{p as F}from"./table-paginate2.js";import{f as J,T as L,a as q,c as M}from"./record.js";import{d as X,r as c,k as A,an as P,aq as z,ar as r,aw as i,ap as l,ax as D,a7 as $,a$ as K,aF as G,ch as H,l as R,aS as Q,bb as Z,aJ as ee,as as S,au as V,bK as te}from"./index.js";import{N as ae}from"./DataTable.js";import{N as oe}from"./Icon.js";import{_ as ne,a as se}from"./DrawerContent.js";import{_ as re}from"./_plugin-vue_export-helper.js";import"./format-length.js";import"./Checkbox.js";import"./use-merged-state.js";import"./RadioGroup.js";import"./get-slot.js";import"./Dropdown.js";import"./Input.js";import"./use-compitable.js";import"./FocusDetector.js";import"./next-frame-once.js";import"./get.js";import"./ChevronRight.js";const le=l("div",{class:"flex justify-between items-center w-full"},[l("h2",{class:"text-xl font-bold"},"确认操作")],-1),ie=l("div",{class:"text-center mb-6"},[l("p",{class:"text-lg mb-4"},'确定"有异议"吗？')],-1),ue={class:"flex justify-end gap-3"},ce=l("div",{class:"flex justify-between items-center w-full"},[l("h2",{class:"text-xl font-bold"},"签字确认")],-1),de={class:"mb-4"},pe=l("p",{class:"text-lg mb-4 text-center"},"请在下方区域进行签字确认",-1),ve={class:"signature-container"},me={class:"flex justify-center mt-4"},fe={class:"flex justify-end gap-3"},B=X({__name:"dialog",props:{visible:{type:Boolean},rowData:{},isObjectionDialog:{type:Boolean},isSignatureDialog:{type:Boolean}},emits:["update:visible","submit","cancel","confirm-objection","confirm-signature"],setup(U,{emit:d}){const v=U,x=c({items:[]}),k=async t=>{var n;try{const o=await J({ID:t,type:L.Take});if(o.error){x.value.items=[];return}x.value.items=((n=o.data)==null?void 0:n.items)||[]}catch(o){console.error("获取详情失败:",o),x.value.items=[]}};A(()=>v.visible,(t,n)=>{if(t&&!n&&v.rowData&&!v.isObjectionDialog&&!v.isSignatureDialog){const o=Number(v.rowData.id);k(o)}else t||(x.value.items=[],v.isSignatureDialog&&C())});const g=()=>{d("update:visible",!1),d("cancel")},m=()=>{d("confirm-objection")},s=c(null),_=c(!1),h=c(0),y=c(0),u=t=>{var e,a,N,O;if(!s.value)return{x:0,y:0};const n=s.value.getBoundingClientRect();let o,b;if(t.type.startsWith("touch")){const f=t;o=((e=f.touches[0])==null?void 0:e.clientX)||((a=f.changedTouches[0])==null?void 0:a.clientX),b=((N=f.touches[0])==null?void 0:N.clientY)||((O=f.changedTouches[0])==null?void 0:O.clientY)}else{const f=t;o=f.clientX,b=f.clientY}return{x:o-n.left,y:b-n.top}},I=t=>{t.preventDefault(),_.value=!0;const n=u(t);h.value=n.x,y.value=n.y},j=t=>{if(!_.value||!s.value)return;t.preventDefault();const n=s.value.getContext("2d");if(!n)return;const o=u(t);n.beginPath(),n.moveTo(h.value,y.value),n.lineTo(o.x,o.y),n.strokeStyle="#000000",n.lineWidth=2,n.lineCap="round",n.lineJoin="round",n.stroke(),h.value=o.x,y.value=o.y},p=()=>{_.value=!1},C=()=>{if(!s.value)return;const t=s.value.getContext("2d");t&&t.clearRect(0,0,s.value.width,s.value.height)},T=()=>{if(!s.value)return!0;const t=s.value.getContext("2d");if(!t)return!0;const n=t.getImageData(0,0,s.value.width,s.value.height);for(let o=0;o<n.data.length;o+=4)if(n.data[o+3]!==0)return!1;return!0},Y=()=>{if(T()){alert("签字内容不能为空");return}if(!s.value)return;const t=s.value.toDataURL("image/png");d("confirm-signature",t)};return(t,n)=>{const o=$,b=K,e=G;return t.isObjectionDialog?(P(),z(e,{key:0,show:t.visible,"onUpdate:show":g,preset:"card",closable:"",style:{width:"400px",margin:"0 auto"}},{header:r(()=>[le]),default:r(()=>[i(b,null,{default:r(()=>[ie,l("div",ue,[i(o,{onClick:g},{default:r(()=>[D("返回")]),_:1}),i(o,{type:"primary",onClick:m},{default:r(()=>[D("确定")]),_:1})])]),_:1})]),_:1},8,["show"])):t.isSignatureDialog?(P(),z(e,{key:1,show:t.visible,"onUpdate:show":g,preset:"card",closable:"",style:{width:"600px",margin:"0 auto"}},{header:r(()=>[ce]),default:r(()=>[i(b,null,{default:r(()=>[l("div",de,[pe,l("div",ve,[l("canvas",{ref_key:"signatureCanvas",ref:s,width:"550",height:"300",style:{border:"2px solid #e0e0e0","border-radius":"8px","background-color":"white",cursor:"crosshair"},onMousedown:I,onMousemove:j,onMouseup:p,onMouseout:p,onTouchstart:I,onTouchmove:j,onTouchend:p},null,544)]),l("div",me,[i(o,{onClick:C,style:{"margin-right":"10px"}},{default:r(()=>[D("清除")]),_:1})])]),l("div",fe,[i(o,{onClick:g},{default:r(()=>[D("返回")]),_:1}),i(o,{type:"primary",onClick:Y},{default:r(()=>[D("确定")]),_:1})])]),_:1})]),_:1},8,["show"])):(P(),z(e,{key:2,show:t.visible,"onUpdate:show":g,preset:"card",closable:"",style:{width:"80%",height:"45rem",margin:"0 auto"}},{header:r(()=>[]),_:1},8,["show"]))}}});const ge={class:"operation-area"},_e={class:"flex justify-between items-center"},he={class:"flex items-center"},ye={class:"flex items-center text-gray-600 text-sm"},be={class:"mt-4"},we=X({__name:"index",setup(U){const d=H(),v=R({get:()=>d.showDrawer,set:e=>d.toggleDrawer(e)}),x=Q(),k=R(()=>{var e;return(e=x.userInfo)==null?void 0:e.userId}),g=Z(),m=c(null),s=c(0),_=c(0),h=c(!1),y=c(!1);A(()=>d.showDrawer,e=>{e?C():(p.value=[],u.value.currentPage=1)});const u=c({totalItems:100,pageSize:F,currentPage:1}),I=e=>{u.value.currentPage=e,C()},j=c([{title:"序号",key:"index",render:(e,a)=>a+1},{title:"耗材名称",key:"name"},{title:"耗材编码",key:"code"},{title:"取货人",key:"userName"},{title:"操作类型",key:"type",render:e=>e.type==="take"?"取用":e.type==="return"?"归还":e.type},{title:"规格型号",key:"spec"},{title:"单位",key:"unit"},{title:"数量",key:"number"},{title:"批号",key:"batch"},{title:"生产厂家",key:"manufacturer"},{title:"入库时间",key:"inboundTime"},{title:"效期",key:"expiryDate"}]),p=c([]),C=async()=>{try{const e=te().subtract(1,"day").format("YYYY-MM-DD"),a=await q({page:u.value.currentPage,pagesize:u.value.pageSize,previousDate:e,type:"take"});if(a.error){p.value=[],u.value.totalItems=0,m.value=null,s.value=0,_.value=0;return}p.value=a.data.items,u.value.totalItems=a.data.total,u.value.pageSize=a.data.pagesize,u.value.currentPage=a.data.page,m.value=a.data.id,s.value=a.data.takeNum||0,_.value=a.data.returnNum||0}catch(e){console.error("获取当日取用归还记录列表失败:",e),p.value=[],u.value.totalItems=0,m.value=null,s.value=0,_.value=0}},T=c(!1),Y=c({}),t=()=>{h.value=!0},n=async()=>{try{if(!m.value){console.error("记录ID不存在");return}if(!k.value){console.error("用户ID不存在");return}const e=await M({id:m.value,isObjection:!0,userID:Number(k.value)});if(e.error){console.error("提交异议失败:",e.error);return}g.success("提交异议成功"),h.value=!1,d.toggleDrawer(!1)}catch(e){console.error("提交异议时发生错误:",e)}},o=()=>{y.value=!0},b=async e=>{try{if(!m.value){console.error("记录ID不存在");return}if(!k.value){console.error("用户ID不存在");return}const a=await M({id:m.value,isObjection:!1,signImage:e,userID:Number(k.value)});if(a.error){console.error("签字确认失败:",a.error);return}g.success("签字确认成功"),y.value=!1,d.toggleDrawer(!1)}catch(a){console.error("签字确认时发生错误:",a)}};return(e,a)=>{const N=ee("WarningOutline"),O=oe,f=ne,E=se;return P(),z(E,{show:v.value,"onUpdate:show":a[4]||(a[4]=w=>v.value=w),placement:"right","auto-focus":!1,style:{width:"100%"}},{default:r(()=>[i(f,{title:"取用归还确认",closable:""},{footer:r(()=>[i(S($),{type:"primary",style:{"margin-right":"8px"},onClick:a[3]||(a[3]=w=>S(d).toggleDrawer(!1))},{default:r(()=>[D(" 返回 ")]),_:1})]),default:r(()=>[l("div",ge,[l("div",_e,[l("div",he,[i(S($),{disabled:p.value.length<=0,type:"primary",onClick:t},{default:r(()=>[D("有异议")]),_:1},8,["disabled"]),i(S($),{disabled:p.value.length<=0,type:"primary",style:{"margin-left":"10px"},onClick:o},{default:r(()=>[D("签字确认")]),_:1},8,["disabled"])]),l("div",ye,[i(O,{color:"#F0A020",size:"16",class:"mr-1"},{default:r(()=>[i(N)]),_:1}),l("span",null,"出库耗材"+V(s.value)+"种，归还耗材"+V(_.value)+"种",1)])])]),l("div",be,[i(S(ae),{columns:j.value,data:p.value},null,8,["columns","data"])]),i(W,{total:u.value.totalItems,"page-size":u.value.pageSize,"current-page":u.value.currentPage,onPageChange:I},null,8,["total","page-size","current-page"]),i(B,{visible:T.value,"onUpdate:visible":a[0]||(a[0]=w=>T.value=w),rowData:Y.value},null,8,["visible","rowData"]),i(B,{visible:h.value,"onUpdate:visible":a[1]||(a[1]=w=>h.value=w),rowData:{},isObjectionDialog:!0,onConfirmObjection:n},null,8,["visible"]),i(B,{visible:y.value,"onUpdate:visible":a[2]||(a[2]=w=>y.value=w),rowData:{},isSignatureDialog:!0,onConfirmSignature:b},null,8,["visible"])]),_:1})]),_:1},8,["show"])}}});const Ae=re(we,[["__scopeId","data-v-d23d9ad1"]]);export{Ae as default};
