import{I as ne}from"./inventory-loading.js";import{d as re,b4 as se,r as i,bb as oe,aS as ue,bI as le,b9 as ie,l as k,k as ce,cz as de,cO as A,o as ve,C as pe,an as j,ao as V,ap as _,au as q,aw as h,bN as me,ar as K,ax as U,as as R,a7 as B,aB as fe,h as ge,bR as $,bM as ye,cP as he,aC as _e,aD as be}from"./index.js";import{T as Ie}from"./table-paginate.js";import{p as xe}from"./table-paginate2.js";import{l as Se}from"./lodash.js";import{N as ke}from"./DataTable.js";import{_ as De}from"./Input.js";import{_ as we}from"./_plugin-vue_export-helper.js";import"./Spin.js";import"./use-compitable.js";import"./GradientText.js";import"./use-houdini.js";import"./format-length.js";import"./Checkbox.js";import"./use-merged-state.js";import"./RadioGroup.js";import"./get-slot.js";import"./Dropdown.js";import"./FocusDetector.js";import"./next-frame-once.js";import"./get.js";import"./Icon.js";import"./ChevronRight.js";const Ce=b=>(_e("data-v-5d712a46"),b=b(),be(),b),Pe=Ce(()=>_("div",{class:"center-title"},[_("div",{class:"stock-in"},[_("h1",{class:"text-xl font-bold mb-4"},"上架入库")])],-1)),Ne={class:"mt-2 mb-2 flex justify-between items-center"},Re={class:"text-gray-400"},Be={key:0,class:"flex gap-2",style:{width:"50%"}},Te={class:"flex justify-center mt-4"},Ee=re({__name:"index",setup(b){const T=se(),c=i([]),o=oe(),G=ue(),v=le(),I=ie(),p=i(!1),x=i(0),u=i([]),m=i(""),S=i(""),D=i(!1),d=i(),w=k(()=>{var e;return((e=I.systemSettings)==null?void 0:e.inventoryCountingMethod)==="scanner"}),Q=e=>{const t=u.value.findIndex(n=>n.rfid===e.rfid);t>-1&&(u.value.splice(t,1),C(),o.success("已取消该耗材入库"))},W=[{title:"序号",key:"index",render:(e,t)=>t+1},{title:"耗材子编码",key:"code"},{title:"耗材名称",key:"name"},{title:"规格型号",key:"spec"},{title:"生产厂家",key:"manufacturer"},{title:"品牌",key:"brand"},{title:"单位",key:"unit"},{title:"唯一码",key:"rfid"},{title:"批号",key:"batch"},{title:"入库货柜",key:"cabinetName"},{title:"操作",key:"actions",render:e=>ge(B,{type:"error",onClick:()=>Q(e)},"取消")}],l=i({totalItems:100,pageSize:xe,currentPage:1}),s=i({}),Y=k(()=>Object.keys(s.value).length),H=k(()=>u.value.length),J=k(()=>{const e=(l.value.currentPage-1)*l.value.pageSize,t=e+l.value.pageSize;return u.value.slice(e,t)}),C=()=>{l.value.totalItems=u.value.length},E=e=>{l.value={...l.value,currentPage:e},C()};ce(()=>u.value.length,()=>{C(),l.value.currentPage!==1&&(l.value.currentPage=1)},{});const X=Se.debounce(async e=>{var t;try{let n=(t=v.getDeviceBymac(e))==null?void 0:t.id;if(!n){o.error("未找到对应的货柜ID");return}const{data:a,error:r}=await(async()=>(await new Promise(g=>setTimeout(g,300)),de({cabinetID:n,dataList:s.value[e].RFID})))();if(r)return;let{notInStockData:f}=a;if(f.length>0){const g=f.join(",");let{data:y}=await A(g);if(y&&Array.isArray(y.items)){o.success(`已获取到${y.items.length}条库存数据`),y.items.forEach(N=>{var M,z;const L=u.value.findIndex(ae=>ae.rfid===N.rfid);L>-1?u.value[L]={...N,cabinetName:((M=v.getDeviceBymac(e))==null?void 0:M.name)||""}:u.value.push({...N,cabinetName:((z=v.getDeviceBymac(e))==null?void 0:z.name)||""})});return}else{o.error("未找到对应的库存数据");return}}else if(f.length===0){o.info("暂无要上架入库的耗材信息！");return}}catch(n){o.error(`停止盘点处理失败: ${n}`)}finally{p.value=!1,x.value=0,c.value=[],s.value[e].RFID=[]}},3e3);function Z(){T.subscribe($.RFID_TAGS,(e,t)=>{if(I.inventoryType==="inbound"){const{EPC:n,IP:a}=e,r=n.replace(/\s+/g,"").replace(/0{2}$/,"").padStart(18,"0");if(r.startsWith("E")){console.error("检测到异常标签:",r);return}if(c.value.includes(r))return;c.value.push(r),s.value&&s.value[a]?s.value[a].RFID.includes(r)||s.value[a].RFID.push(r):s.value[a]||(s.value[a]={MAC:a,RFID:[r],isStopInventory:!1}),x.value=c.value.length,!p.value&&c.value.length>0&&(p.value=!0)}}),T.subscribe($.RFID_INVENTORY_RESULT,async e=>{const{ReaderId:t}=e;s.value&&s.value[t]&&s.value[t].RFID&&(s.value[t].isStopInventory=!0,X(t))})}const P=async()=>{try{if(!m.value){o.warning("请输入院内码或条形码");return}const e=m.value;m.value="";const{data:t}=await ye({dataList:[e]});if(t){if(t.takeList.length>0){o.warning("该耗材已在其他货柜入库，无需再次入库！");return}else if(t.returnList.length>0){o.warning("该耗材已在其他货柜出库，无需再次入库！");return}else if(t.errorData.length>0){o.warning("耗材异常！");return}let{data:n}=await A(e);if(n&&Array.isArray(n.items)){n.items.forEach(a=>{var f,g;u.value.findIndex(y=>y.rfid===a.rfid)>-1||u.value.push({...a,cabinetName:((f=v.getMainCabinet)==null?void 0:f.name)||((g=Object.values(v.getDevicesObj)[0])==null?void 0:g.name)||""})});return}else{console.log("未找到对应的库存数据");return}}}catch(e){o.error("查询失败: "+e.message)}},ee=async()=>{try{const e={userID:Number(G.userInfo.userId),type:"noOrder",items:u.value.map(a=>({code:a.code,name:a.name,spec:a.spec,manufacturer:a.manufacturer,brand:a.brand,unit:a.unit,rfid:a.rfid,batch:a.batch,productionDate:a.productionDate,expiryDate:a.expiryDate,number:Number(a.num),price:a.price,cabinetID:v.getDeviceByName(a.cabinetName)||0}))};if(e.items.length===0){o.warning("请选择要上架的耗材");return}const{data:t,error:n}=await he(e);if(n)return;o.success(""+t),u.value=[],s.value={},c.value=[],x.value=0,p.value=!1,l.value.totalItems=0,l.value.currentPage=1}catch(e){o.error("上架失败："+e.message)}},F=e=>{D.value||(e.key==="Enter"?S.value.length>0&&(m.value=S.value,P(),S.value=""):e.key.length===1&&(S.value+=e.key))},te=()=>{D.value=!0,d.value&&(d.value.readOnly=!1,d.value.focus({preventScroll:!0}))},O=()=>{D.value=!1,d.value&&(d.value.readOnly=!0,d.value.blur())};return ve(()=>{I.updateInventoryType("inbound"),c.value=[],s.value={},w.value?(window.addEventListener("keydown",F),O()):Z(),E(l.value.currentPage)}),pe(()=>{I.updateInventoryType("other"),w.value&&window.removeEventListener("keydown",F)}),(e,t)=>{const n=De,a=ne;return j(),V("div",null,[Pe,_("div",Ne,[_("div",Re," 入库货柜数量："+q(Y.value)+" 个，入库耗材数量："+q(H.value)+" 个 ",1),w.value?(j(),V("div",Be,[h(n,{ref_key:"inputRef",ref:d,value:m.value,"onUpdate:value":t[0]||(t[0]=r=>m.value=r),valueModifiers:{trim:!0},placeholder:"请输入院内码或条形码",clearable:"",class:"flex-1","allow-input":r=>/^\d*$/.test(r),onKeyup:me(P,["enter"]),onFocus:te,onBlur:O},null,8,["value","allow-input","onKeyup"]),h(R(B),{type:"primary",onClick:P},{default:K(()=>[U("扫码查询")]),_:1})])):fe("",!0)]),h(R(ke),{columns:W,data:J.value,"max-height":480},null,8,["data"]),h(Ie,{total:l.value.totalItems,"page-size":l.value.pageSize,"current-page":l.value.currentPage,onPageChange:E},null,8,["total","page-size","current-page"]),_("div",Te,[h(R(B),{type:"primary",onClick:ee,disabled:u.value.length<=0},{default:K(()=>[U("确定上架")]),_:1},8,["disabled"])]),h(a,{"model-value":p.value,"onUpdate:modelValue":t[1]||(t[1]=r=>p.value=r),"current-count":x.value},null,8,["model-value","current-count"])])}}});const nt=we(Ee,[["__scopeId","data-v-5d712a46"]]);export{nt as default};
