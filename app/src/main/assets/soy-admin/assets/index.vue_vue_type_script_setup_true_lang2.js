import{d as J,bb as W,aS as se,bI as X,b9 as Z,r as i,l as j,k as O,o as V,y as H,C as ee,an as q,aq as oe,ar as N,aw as y,ap as v,ao as te,bN as Q,ax as K,aB as re,bM as le,h as ue,cQ as ie,bK as A,a7 as ae,a$ as ce,aF as de,bO as ve,b4 as pe,cz as me,as as fe,bR as G}from"./index.js";import{T as ye}from"./table-paginate.js";import{p as he}from"./table-paginate2.js";import{_ as ge}from"./Input.js";import{a as _e,_ as be}from"./Dropdown.js";import{N as Ie}from"./DataTable.js";import{l as Se}from"./lodash.js";import{I as De}from"./inventory-loading.js";const we=v("div",{class:"flex justify-between items-center w-full"},[v("h2",{class:"text-xl font-bold"},"退库耗材")],-1),ke={class:"grid grid-cols-3 gap-4 mb-4"},xe={class:"flex items-center"},Ce=v("span",{class:"mr-6"},"退库人:",-1),Ne={class:"flex items-center"},Pe=v("span",{class:"mr-4"},"退库单号:",-1),Re={class:"flex items-center"},Be=v("span",{class:"mr-4"},"退库原因:",-1),Te={key:0,class:"mb-4"},Ee={class:"flex items-center gap-4"},Me=v("span",{class:"mr-2"},"扫码输入:",-1),$e=v("div",{class:"text-sm text-gray-500 mt-1"},"提示：扫描条码后按回车键或点击查询按钮",-1),Fe={class:"flex justify-end mt-4 space-x-4 pr-4 pb-4"},Ue=J({__name:"dialog",props:{visible:{type:Boolean},rowData:{}},emits:["update:visible","cancel","confirm"],setup(Y,{emit:T}){const w=Y,p=W(),x=se(),b=X(),E=Z(),P=i([{label:"近效期",value:"nearExpiry"},{label:"已过期",value:"expired"},{label:"其他",value:"other"}]),r=j(()=>{var a;return((a=E.systemSettings)==null?void 0:a.inventoryCountingMethod)==="scanner"}),h=i(""),m=i(),D=i(""),R=i(!1),B=i([]),g=i({returnPerson:x.userInfo.userName,returnNumber:"",reason:"nearExpiry"}),M=a=>{R.value||(a.key==="Enter"?D.value.length>0&&(h.value=D.value,$(),D.value=""):a.key.length===1&&(D.value+=a.key))},z=()=>{R.value=!0,m.value&&(m.value.readOnly=!1,m.value.focus({preventScroll:!0}))},F=()=>{R.value=!1,m.value&&(m.value.readOnly=!0,m.value.blur())},U=()=>{m.value&&(m.value.readOnly=!0)},$=async()=>{if(!h.value){p.error("请输入院内码或条形码");return}const a=h.value;if(h.value="",B.value.includes(a)){p.warning("该条码已经扫描过了");return}try{const{data:t}=await le({dataList:[a]});if(t){const{takeList:l,errorData:d,notInStockData:o,returnList:S}=t;if(l&&l.length>0){const k=l.map(C=>{var c;return{...C,cabinetName:((c=b.getDeviceById(C.cabinetID))==null?void 0:c.name)||"未知货柜",number:1,returnQuantity:1}}).filter(C=>!n.value.some(c=>c.rfid===C.rfid));if(k.length>0){if(n.value.push(...k),B.value.push(a),r.value){const C=k.map(c=>String(c.id));I.value.push(...C)}p.success(`成功添加 ${k.length} 个耗材`)}else p.warning("该耗材已存在于列表中")}d&&d.length>0&&p.warning(`发现 ${d.length} 个异常耗材`),o&&o.length>0&&p.warning(`发现 ${o.length} 个未入库耗材`),S&&S.length>0&&p.warning(`发现 ${S.length} 个已退库耗材`),(!l||l.length===0)&&(!S||S.length===0)&&(!d||d.length===0)&&(!o||o.length===0)&&p.error("未找到对应的耗材信息")}}catch{p.error("扫码查询失败，请重试")}},I=i([]),e=()=>[{type:"selection"},{title:"耗材名称",key:"name"},{title:"子编码",key:"code"},{title:"规格型号",key:"spec"},{title:"批号",key:"batch"},{title:"品牌",key:"brand"},{title:"生产厂家",key:"manufacturer"},{title:"货柜名称",key:"cabinetName"},{title:"退库数量",key:"number"},{title:"唯一码",key:"rfid"},{title:"货柜ID",key:"cabinetID",render:a=>ue("span",a.cabinetID)}];O(()=>w.visible,async a=>{var t,l;a&&(E.systemSettings||await E.initSystemSettings(),r.value&&(n.value=[],B.value=[],h.value="",I.value=[]),(t=w.rowData[0])!=null&&t.expiryStatus&&(g.value.reason=(l=w.rowData[0])==null?void 0:l.expiryStatus),n.value=w.rowData.filter((d,o,S)=>o===S.findIndex(k=>k.id===d.id&&k.rfid===d.rfid)).map(d=>{var o;return{...d,cabinetName:((o=b.getDeviceById(d.cabinetID))==null?void 0:o.name)||"未知货柜"}}),I.value=n.value.map(d=>String(d.id)),s.value.totalItems=n.value.length,console.log("初始化分页信息：",s.value),s.value.currentPage=1)});const _=a=>{I.value=a.map(t=>String(t))},n=i([]),s=i({totalItems:n.value.length,pageSize:he,currentPage:1}),f=j(()=>{const a=(s.value.currentPage-1)*s.value.pageSize,t=a+s.value.pageSize;return n.value.slice(a,t).map(l=>({...l,_checked:I.value.includes(String(l.id))}))}),u=a=>{s.value.currentPage=a,s.value.totalItems=[...new Set(n.value)].length},L=()=>{r.value&&(B.value=[],h.value=""),T("update:visible",!1),T("cancel")};V(async()=>{r.value&&H(()=>{U()})}),ee(()=>{r.value&&document.removeEventListener("keydown",M)}),O(()=>w.visible,a=>{r.value&&(a?document.addEventListener("keydown",M):document.removeEventListener("keydown",M))});const ne=async()=>{var a;try{if(!g.value.reason){p.error("请选择退库原因");return}if(I.value.length===0){p.error("请选择要退库的耗材");return}const t={userID:Number((a=x.userInfo)==null?void 0:a.userId),type:"noOrder",reason:g.value.reason,list:I.value.map(d=>{const o=n.value.find(S=>S.id===Number(d));if(!o||o.id===void 0||!o.rfid||o.cabinetID===void 0)throw new Error("选中的数据项缺少必需字段");return{id:o.id,rfid:o.rfid,number:String(o.number),cabinetID:o.cabinetID}})},{data:l}=await ie(t);l&&(p.success("退库单提交成功"),n.value=[],I.value=[],r.value&&(B.value=[],h.value=""),g.value={returnPerson:x.userInfo.userName,returnNumber:`TK${A().format("YYYYMMDDHHmmss")}`,reason:""},T("update:visible",!1),T("confirm"))}catch(t){p.error("退库单提交失败"),console.error("API Error:",t)}};return O(()=>w.rowData,a=>{a&&(n.value=w.rowData.map(t=>{var l;return{...t,cabinetName:((l=b.getDeviceById(t.cabinetID))==null?void 0:l.name)||"未知货柜",number:1,returnQuantity:t.number||1}}),H(()=>{I.value=n.value.map(t=>String(t.id))}),g.value={returnPerson:x.userInfo.userName,returnNumber:`TK${A().format("YYYYMMDDHHmmss")}`,reason:""},s.value.totalItems=n.value.length,s.value.currentPage=1)},{deep:!0,immediate:!0}),(a,t)=>{const l=ge,d=_e,o=ae,S=Ie,k=ce,C=de;return q(),oe(C,{show:a.visible,"onUpdate:show":L,preset:"card",closable:"",style:{width:"fit-content"},onKeydown:t[4]||(t[4]=Q(ve(()=>{},["prevent"]),["enter"]))},{header:N(()=>[we]),default:N(()=>[y(k,null,{default:N(()=>[v("div",ke,[v("div",xe,[Ce,y(l,{value:g.value.returnPerson,"onUpdate:value":t[0]||(t[0]=c=>g.value.returnPerson=c),placeholder:"退库人",style:{width:"180px"},disabled:""},null,8,["value"])]),v("div",Ne,[Pe,y(l,{value:g.value.returnNumber,"onUpdate:value":t[1]||(t[1]=c=>g.value.returnNumber=c),placeholder:"自动生成",style:{width:"180px"},disabled:""},null,8,["value"])]),v("div",Re,[Be,y(d,{value:g.value.reason,"onUpdate:value":t[2]||(t[2]=c=>g.value.reason=c),options:P.value,placeholder:"请选择",style:{width:"180px"}},null,8,["value","options"])])]),r.value?(q(),te("div",Te,[v("div",Ee,[Me,y(l,{ref_key:"inputRef",ref:m,value:h.value,"onUpdate:value":t[3]||(t[3]=c=>h.value=c),valueModifiers:{trim:!0},placeholder:"请输入院内码",clearable:"","allow-input":c=>/^\d*$/.test(c),style:{width:"300px"},onKeyup:Q($,["enter"]),onFocus:z,onBlur:F},null,8,["value","allow-input","onKeyup"]),y(o,{type:"primary",onClick:$},{default:N(()=>[K("查询")]),_:1})]),$e])):re("",!0),y(S,{columns:e(),"row-key":c=>String(c.id),data:f.value,"checked-row-keys":I.value,"onUpdate:checkedRowKeys":_},null,8,["columns","row-key","data","checked-row-keys"])]),_:1}),y(ye,{total:s.value.totalItems,"page-size":s.value.pageSize,"current-page":s.value.currentPage,onPageChange:u},null,8,["total","page-size","current-page"]),v("div",Fe,[y(o,{onClick:L},{default:N(()=>[K("取消")]),_:1}),y(o,{type:"primary",onClick:ne},{default:N(()=>[K("提交退库单")]),_:1})])]),_:1},8,["show"])}}});const Le=v("div",{class:"flex items-center mb-4"},[v("h2",{class:"text-xl font-bold"},"新建退库单")],-1),Oe={class:"table-container mt-4 relative"},Ke=v("div",{class:"mb-4"},"点击【开始退库】按钮，根据提示，打开柜门，取出退库耗材。",-1),Je=J({__name:"index",props:{selectedMaterial:{type:Object,default:()=>({})}},emits:["clear-stock"],setup(Y,{emit:T}){const w=Y,p=X(),x=W(),b=Z(),E=pe(),P=i([]),r=i({}),h=i(!1),m=i([]),D=i(!1),R=i(0),B={showPopover:i(!1),handleUpdateShow(e){}},g=i(""),M=i([]),z=j(()=>{var e;return((e=b.systemSettings)==null?void 0:e.inventoryCountingMethod)!=="RFID"}),F=()=>{h.value=!0,z.value?x.info("请使用扫码枪扫描要退库的耗材条码"):x.info("请打开柜门,取出要退库的耗材")},U=Se.debounce(async e=>{var _;if(r.value[e])try{r.value[e].isStopInventory=!0;const n=(_=p.getDeviceBymac(e))==null?void 0:_.id;if(!n){x.error("未找到对应的货柜ID");return}const{data:s}=await me({cabinetID:n,dataList:r.value[e].RFID});if(s!=null&&s.takeList){const f=s.takeList.map(u=>({rfid:u.rfid,id:u.id,number:1,name:u.name,code:u.code,spec:u.spec,batch:u.batch,manufacture:u.manufacture,unit:u.unit,brand:u.brand,cabinetID:p.getDeviceBymac(e).id})).filter(u=>!m.value.some(L=>L.rfid===u.rfid));m.value.push(...f)}}catch(n){console.error("处理失败:",n)}finally{r.value[e].isStopInventory=!1,D.value=!1,R.value=0,P.value=[],r.value[e].RFID=[],U.cancel()}},3e3);function $(){var e;((e=b.systemSettings)==null?void 0:e.inventoryCountingMethod)==="RFID"&&(E.subscribe(G.RFID_TAGS,(_,n)=>{if(b.inventoryType==="outbound"){const{EPC:s,IP:f}=_,u=s.replace(/\s+/g,"").replace(/0{2}$/,"").padStart(18,"0");if(P.value.includes(u))return;P.value.push(u),R.value++,!D.value&&P.value.length>0&&(D.value=!0),r.value&&r.value[f]&&!r.value[f].RFID.includes(u)?r.value[f].RFID.push(u):r.value[f]||(r.value[f]={MAC:f,RFID:[u],isStopInventory:!1})}}),E.subscribe(G.RFID_INVENTORY_RESULT,_=>{var s;const{ReaderId:n}=_;((s=r.value[n])==null?void 0:s.isStopInventory)===!1&&U(n)}))}const I=()=>{m.value=[],P.value=[],r.value={},M.value=[],g.value=""};return O(()=>w.selectedMaterial,e=>{e&&e.rfid&&(setTimeout(()=>{F()}),console.log("接收到选中的耗材信息：",e),m.value=[...m.value,{id:e.id,rfid:e.rfid,number:e.number,cabinetID:e.cabinetID||0,name:e.name,code:e.code,brand:e.brand,spec:e.spec,manufacture:e.manufacture,expiryStatus:e.expiryStatus}])},{immediate:!0}),V(async()=>{var e;b.updateInventoryType("outbound"),b.systemSettings||await b.initSystemSettings(),((e=b.systemSettings)==null?void 0:e.inventoryCountingMethod)==="RFID"&&$()}),ee(()=>{b.updateInventoryType("other"),T("clear-stock")}),(e,_)=>{const n=ae,s=be;return q(),te("div",null,[Le,v("div",Oe,[Ke,y(s,{placement:"bottom",trigger:"click","onUpdate:show":B.handleUpdateShow},{trigger:N(()=>[y(n,{type:"primary",onClick:F},{default:N(()=>[K("开始退库")]),_:1})]),_:1},8,["onUpdate:show"]),y(fe(Ue),{visible:h.value,rowData:m.value,"onUpdate:visible":_[0]||(_[0]=f=>h.value=f),onConfirm:I},null,8,["visible","rowData"]),y(De,{"model-value":D.value,"onUpdate:modelValue":_[1]||(_[1]=f=>D.value=f),"current-count":R.value},null,8,["model-value","current-count"])])])}}});export{Je as _};
