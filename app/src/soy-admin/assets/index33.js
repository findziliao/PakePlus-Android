import{d as G,h as y,c as L,j as Q,b as $,a as se,c0 as Ne,u as me,r as f,l as W,n as ve,A as Ie,by as he,q as Se,B as Ee,e7 as Re,a6 as X,e8 as ke,t as De,a4 as be,b$ as Pe,aK as _e,dL as Te,bZ as $e,E as ze,bq as Be,dA as pe,e9 as Me,N as Ae,an as I,aq as H,ar as x,aw as q,ax as O,as as ee,a7 as ie,ap as a,ao as U,aA as Z,au as h,az as Y,aF as Fe,bI as Le,aS as Oe,b4 as Ue,bb as je,b9 as Ve,o as qe,C as Ke,bR as oe,bN as He,aB as fe,cP as We,ea as Ge,bM as Qe,aC as Ze,aD as Ye}from"./index.js";import{I as Je}from"./inventory-loading.js";import{u as Xe}from"./use-merged-state.js";import{C as et}from"./ChevronRight.js";import{_ as tt}from"./Input.js";import{_ as at}from"./_plugin-vue_export-helper.js";import"./Spin.js";import"./use-compitable.js";import"./GradientText.js";import"./use-houdini.js";import"./format-length.js";const nt=G({name:"ChevronLeft",render(){return y("svg",{viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"},y("path",{d:"M10.3536 3.14645C10.5488 3.34171 10.5488 3.65829 10.3536 3.85355L6.20711 8L10.3536 12.1464C10.5488 12.3417 10.5488 12.6583 10.3536 12.8536C10.1583 13.0488 9.84171 13.0488 9.64645 12.8536L5.14645 8.35355C4.95118 8.15829 4.95118 7.84171 5.14645 7.64645L9.64645 3.14645C9.84171 2.95118 10.1583 2.95118 10.3536 3.14645Z",fill:"currentColor"}))}}),rt=L("collapse","width: 100%;",[L("collapse-item",`
 font-size: var(--n-font-size);
 color: var(--n-text-color);
 transition:
 color .3s var(--n-bezier),
 border-color .3s var(--n-bezier);
 margin: var(--n-item-margin);
 `,[Q("disabled",[$("header","cursor: not-allowed;",[$("header-main",`
 color: var(--n-title-text-color-disabled);
 `),L("collapse-item-arrow",`
 color: var(--n-arrow-color-disabled);
 `)])]),L("collapse-item","margin-left: 32px;"),se("&:first-child","margin-top: 0;"),se("&:first-child >",[$("header","padding-top: 0;")]),Q("left-arrow-placement",[$("header",[L("collapse-item-arrow","margin-right: 4px;")])]),Q("right-arrow-placement",[$("header",[L("collapse-item-arrow","margin-left: 4px;")])]),$("content-wrapper",[$("content-inner","padding-top: 16px;"),Ne({duration:"0.15s"})]),Q("active",[$("header",[Q("active",[L("collapse-item-arrow","transform: rotate(90deg);")])])]),se("&:not(:first-child)","border-top: 1px solid var(--n-divider-color);"),$("header",`
 font-size: var(--n-title-font-size);
 display: flex;
 flex-wrap: nowrap;
 align-items: center;
 transition: color .3s var(--n-bezier);
 position: relative;
 padding: var(--n-title-padding);
 color: var(--n-title-text-color);
 cursor: pointer;
 `,[$("header-main",`
 display: flex;
 flex-wrap: nowrap;
 align-items: center;
 font-weight: var(--n-title-font-weight);
 transition: color .3s var(--n-bezier);
 flex: 1;
 color: var(--n-title-text-color);
 `),$("header-extra",`
 display: flex;
 align-items: center;
 transition: color .3s var(--n-bezier);
 color: var(--n-text-color);
 `),L("collapse-item-arrow",`
 display: flex;
 transition:
 transform .15s var(--n-bezier),
 color .3s var(--n-bezier);
 font-size: 18px;
 color: var(--n-arrow-color);
 `)])])]),lt=Object.assign(Object.assign({},ve.props),{defaultExpandedNames:{type:[Array,String],default:null},expandedNames:[Array,String],arrowPlacement:{type:String,default:"left"},accordion:{type:Boolean,default:!1},displayDirective:{type:String,default:"if"},onItemHeaderClick:[Function,Array],"onUpdate:expandedNames":[Function,Array],onUpdateExpandedNames:[Function,Array],onExpandedNamesChange:{type:[Function,Array],validator:()=>!0,default:void 0}}),ge=Ee("n-collapse"),st=G({name:"Collapse",props:lt,setup(e,{slots:m}){const{mergedClsPrefixRef:d,inlineThemeDisabled:l,mergedRtlRef:s}=me(e),n=f(e.defaultExpandedNames),o=W(()=>e.expandedNames),v=Xe(o,n),b=ve("Collapse","-collapse",rt,Re,e,d);function c(w){const{"onUpdate:expandedNames":i,onUpdateExpandedNames:S,onExpandedNamesChange:D}=e;S&&X(S,w),i&&X(i,w),D&&X(D,w),n.value=w}function _(w){const{onItemHeaderClick:i}=e;i&&X(i,w)}function u(w,i,S){const{accordion:D}=e,{value:P}=v;if(D)w?(c([i]),_({name:i,expanded:!0,event:S})):(c([]),_({name:i,expanded:!1,event:S}));else if(!Array.isArray(P))c([i]),_({name:i,expanded:!0,event:S});else{const E=P.slice(),A=E.findIndex(T=>i===T);~A?(E.splice(A,1),c(E),_({name:i,expanded:!1,event:S})):(E.push(i),c(E),_({name:i,expanded:!0,event:S}))}}Ie(ge,{props:e,mergedClsPrefixRef:d,expandedNamesRef:v,slots:m,toggleItem:u});const M=he("Collapse",s,d),z=W(()=>{const{common:{cubicBezierEaseInOut:w},self:{titleFontWeight:i,dividerColor:S,titlePadding:D,titleTextColor:P,titleTextColorDisabled:E,textColor:A,arrowColor:T,fontSize:te,titleFontSize:ae,arrowColorDisabled:ne,itemMargin:J}}=b.value;return{"--n-font-size":te,"--n-bezier":w,"--n-text-color":A,"--n-divider-color":S,"--n-title-padding":D,"--n-title-font-size":ae,"--n-title-text-color":P,"--n-title-text-color-disabled":E,"--n-title-font-weight":i,"--n-arrow-color":T,"--n-arrow-color-disabled":ne,"--n-item-margin":J}}),B=l?Se("collapse",void 0,z,e):void 0;return{rtlEnabled:M,mergedTheme:b,mergedClsPrefix:d,cssVars:l?void 0:z,themeClass:B==null?void 0:B.themeClass,onRender:B==null?void 0:B.onRender}},render(){var e;return(e=this.onRender)===null||e===void 0||e.call(this),y("div",{class:[`${this.mergedClsPrefix}-collapse`,this.rtlEnabled&&`${this.mergedClsPrefix}-collapse--rtl`,this.themeClass],style:this.cssVars},this.$slots)}}),ot=G({name:"CollapseItemContent",props:{displayDirective:{type:String,required:!0},show:Boolean,clsPrefix:{type:String,required:!0}},setup(e){return{onceTrue:ke(De(e,"show"))}},render(){return y(Pe,null,{default:()=>{const{show:e,displayDirective:m,onceTrue:d,clsPrefix:l}=this,s=m==="show"&&d,n=y("div",{class:`${l}-collapse-item__content-wrapper`},y("div",{class:`${l}-collapse-item__content-inner`},this.$slots));return s?be(n,[[_e,e]]):e?n:null}})}}),it={title:String,name:[String,Number],disabled:Boolean,displayDirective:String},dt=G({name:"CollapseItem",props:it,setup(e){const{mergedRtlRef:m}=me(e),d=Te(),l=$e(()=>{var u;return(u=e.name)!==null&&u!==void 0?u:d}),s=ze(ge);s||Be("collapse-item","`n-collapse-item` must be placed inside `n-collapse`.");const{expandedNamesRef:n,props:o,mergedClsPrefixRef:v,slots:b}=s,c=W(()=>{const{value:u}=n;if(Array.isArray(u)){const{value:M}=l;return!~u.findIndex(z=>z===M)}else if(u){const{value:M}=l;return M!==u}return!0});return{rtlEnabled:he("Collapse",m,v),collapseSlots:b,randomName:d,mergedClsPrefix:v,collapsed:c,mergedDisplayDirective:W(()=>{const{displayDirective:u}=e;return u||o.displayDirective}),arrowPlacement:W(()=>o.arrowPlacement),handleClick(u){s&&!e.disabled&&s.toggleItem(c.value,l.value,u)}}},render(){const{collapseSlots:e,$slots:m,arrowPlacement:d,collapsed:l,mergedDisplayDirective:s,mergedClsPrefix:n,disabled:o}=this,v=pe(m.header,{collapsed:l},()=>[this.title]),b=m["header-extra"]||e["header-extra"],c=m.arrow||e.arrow;return y("div",{class:[`${n}-collapse-item`,`${n}-collapse-item--${d}-arrow-placement`,o&&`${n}-collapse-item--disabled`,!l&&`${n}-collapse-item--active`]},y("div",{class:[`${n}-collapse-item__header`,!l&&`${n}-collapse-item__header--active`]},y("div",{class:`${n}-collapse-item__header-main`,onClick:this.handleClick},d==="right"&&v,y("div",{class:`${n}-collapse-item-arrow`,key:this.rtlEnabled?0:1},pe(c,{collapsed:l},()=>{var _;return[y(Ae,{clsPrefix:n},{default:(_=e.expandIcon)!==null&&_!==void 0?_:()=>this.rtlEnabled?y(nt,null):y(et,null)})]})),d==="left"&&v),Me(b,{collapsed:l},_=>y("div",{class:`${n}-collapse-item__header-extra`,onClick:this.handleClick},_))),y(ot,{clsPrefix:n,displayDirective:s,show:!l},m))}}),ct={class:"max-h-96 overflow-y-auto"},ut=a("p",{class:"text-red-600 mb-4"},"以下标签不在待上架入库单中，请取出该耗材：",-1),pt=G({__name:"warningDialog",props:{errorTags:{}},emits:["confirm"],setup(e,{emit:m}){const d=f(!1),l=()=>{m("confirm"),d.value=!1};return(s,n)=>(I(),H(ee(Fe),{show:d.value,"onUpdate:show":n[0]||(n[0]=o=>d.value=o),preset:"dialog",title:"标签异常警告",type:"error"},{action:x(()=>[q(ee(ie),{onClick:l},{default:x(()=>[O("确定")]),_:1})]),default:x(()=>[a("div",ct,[ut,a("ul",null,[(I(!0),U(Y,null,Z(s.errorTags,(o,v)=>(I(),U("li",{key:v,class:"py-1"},h(o.RFID)+" (所属货柜："+h(o.CabinetName||"未知")+") ",1))),128))])])]),_:1},8,["show"]))}}),j=e=>(Ze("data-v-040efaff"),e=e(),Ye(),e),ft={class:"flex h-screen flex-col"},mt=j(()=>a("h1",{class:"text-xl font-bold mb-4"},"上架入库",-1)),vt={class:"flex justify-between items-center mb-4"},ht={class:"text-sm text-gray-400 flex-1"},bt={class:"flex gap-2",style:{width:"40%"}},_t=j(()=>a("p",{class:"text-center text-2xl text-gray-400"},"暂无订单数据...",-1)),gt=[_t],xt={class:"flex h-full"},yt={class:"w-1/5 p-4 rounded border border-gray-300 dark:border-gray-700 overflow-y-auto h-full"},wt=["onClick"],Ct={class:"w-4/5 rounded border border-gray-300 dark:border-gray-700 p-4 flex flex-col justify-between h-full"},Nt={class:"flex-1 overflow-y-auto"},It={class:"flex flex-col items-end"},St=j(()=>a("span",{class:"text-gray-500 text-xs"},"已上架 / 待上架总数量",-1)),Et={class:"text-blue-600"},Rt={class:"flex flex-col items-end"},kt=j(()=>a("span",{class:"text-gray-500 text-xs"},"已上架 / 待上架总数量",-1)),Dt={class:"text-blue-600"},Pt={class:"text-blue-600"},Tt={class:"grid grid-cols-4 gap-4 p-2"},$t=j(()=>a("strong",null,"名称:",-1)),zt=j(()=>a("strong",null,"批号:",-1)),Bt=j(()=>a("strong",null,"生产日期:",-1)),Mt=j(()=>a("strong",null,"失效日期:",-1)),At={class:"mt-3 flex justify-center items-center h-3"},Ft=G({__name:"index",setup(e){const m=Le(),d=Oe(),l=Ue(),s=je(),n=Ve(),o=f(),v=f([]),b=f({number:0,cabinetlist:[]}),c=f([]),_=f(m.getDevicesObj),u=f(),M=f([]),z=f(!1),B=f(0),w=f(),i=f(),S=f(),D=W(()=>{var t;return((t=n.systemSettings)==null?void 0:t.inventoryCountingMethod)==="scanner"}),P=f(""),E=f(""),A=f(!1),T=f();function te(t){S.value=t,w.value=[t.orderNo],i.value=0}async function ae(){if(c.value.length===0){s.error("没有需要上架的耗材");return}if(!d.userInfo.userId){s.error("获取用户信息失败，请先登录");return}const{data:t,error:r,message:C}=await We({userID:Number(d.userInfo.userId),type:"hasOrder",items:c.value});r||(t&&(s.success(C+""),c.value=[],b.value.number=0,b.value.cabinetlist=[],o.value=[],v.value=[]),await J())}function ne(){M.value=[]}async function J(){const{data:t,error:r}=await Ge();if(r){console.log(r),o.value=[];return}o.value=t||[],u.value=new Map(o.value.flatMap(C=>C.children.flatMap(R=>R.children.map(k=>[k.rfid,{order:C,child:R,item:k}]))))}function xe(t){var C,R;console.log("收到标签数据:",t.EPC);const r=u.value.get(t.EPC);if(r){const{order:k,child:g,item:N}=r;k.shelfedNumber=(k.shelfedNumber||0)+1,g.shelfedNumber=(g.shelfedNumber||0)+1,N.isShelfed=!0;const K=(C=_.value[t.IP])==null?void 0:C.id,p={rfid:t.EPC,cabinetID:K,name:N.name,batch:N.batch,code:N.code,spec:N.spec,brand:N.brand,manufacturer:N.manufacturer,productionDate:N.productionDate,expiryDate:N.expiryDate,number:1,unit:null,price:null};c.value.push(p)}else M.value.push({RFID:t.EPC,CabinetName:(R=_.value[t.IP])==null?void 0:R.name});b.value.cabinetlist.includes(t.IP)||(b.value.cabinetlist.push(t.IP),b.value.number++)}function ye(){l.subscribe(oe.RFID_TAGS,t=>{let r=t.EPC.replace(/\s+/g,"").replace(/0{2}$/,"").padStart(18,"0");r&&!v.value.includes(r)&&(v.value.push(r),B.value++,!z.value&&v.value.length>0&&(z.value=!0),xe({...t,EPC:r}))}),l.subscribe(oe.RFID_INVENTORY_RESULT,async t=>{z.value=!1,B.value=0})}async function re(){if(!P.value){s.error("请输入院内码或条形码");return}const t=P.value;P.value="";const r=u.value.get(t);if(!r){s.warning("该标签不在待上架单里，请先扫描待上架单标签！");return}const{data:C}=await Qe({dataList:[t]});if(C)if(C.takeList.length>0){s.warning("该耗材已在其他货柜入库，无需再次入库！");return}else if(C.returnList.length>0){s.warning("该耗材已在其他货柜出库，无需再次入库！");return}else if(C.errorData.length>0)s.warning("耗材异常！");else{const{order:R,child:k,item:g}=r;R.shelfedNumber=(R.shelfedNumber||0)+1,k.shelfedNumber=(k.shelfedNumber||0)+1,g.isShelfed=!0;const N=m.getMainCabinet.id||Object.values(m.getDevicesObj)[0].id||0,K={rfid:t,cabinetID:N,name:g.name,batch:g.batch,code:g.code,spec:g.spec,brand:g.brand,manufacturer:g.manufacturer,productionDate:g.productionDate,expiryDate:g.expiryDate,number:1,unit:null,price:null};c.value.push(K)}}const de=t=>{A.value||(t.key==="Enter"?E.value.length>0&&(P.value=E.value,re(),E.value=""):t.key.length===1&&(E.value+=t.key))},we=()=>{A.value=!0,T.value&&(T.value.readOnly=!1,T.value.focus({preventScroll:!0}))},ce=()=>{A.value=!1,T.value&&(T.value.readOnly=!0,T.value.blur())};return qe(async()=>{n.updateInventoryType("inbound"),c.value=[],b.value.number=0,b.value.cabinetlist=[],o.value=[],v.value=[],await J(),D.value?(window.addEventListener("keydown",de),ce()):ye()}),Ke(()=>{D.value?window.removeEventListener("keydown",de):l.unsubscribe(oe.RFID_TAGS),n.updateInventoryType("other")}),(t,r)=>{var g,N,K;const C=tt,R=dt,k=st;return I(),U("div",ft,[mt,a("div",vt,[a("h2",ht," 上架涉及订单数："+h((g=o.value)==null?void 0:g.length)+"个，上架货柜数："+h(b.value.number)+"个，上架耗材数："+h(((N=c.value)==null?void 0:N.length)||0)+"个 ",1),a("div",bt,[D.value?(I(),H(C,{key:0,ref_key:"inputRef",ref:T,value:P.value,"onUpdate:value":r[0]||(r[0]=p=>P.value=p),valueModifiers:{trim:!0},"allow-input":p=>/^\d*$/.test(p),placeholder:"请输入院内码或条形码",clearable:"",class:"flex-1",onKeyup:He(re,["enter"]),onFocus:we,onBlur:ce},null,8,["value","allow-input","onKeyup"])):fe("",!0),D.value?(I(),H(ee(ie),{key:1,type:"primary",onClick:re},{default:x(()=>[O("扫码查询")]),_:1})):fe("",!0)])]),be(a("div",null,gt,512),[[_e,((K=o.value)==null?void 0:K.length)===0]]),a("div",xt,[a("div",yt,[a("ul",null,[(I(!0),U(Y,null,Z(o.value,(p,le)=>(I(),U("li",{key:le,class:"p-2 hover:bg-gray-100 dark:hover:bg-[#3C3C3C] cursor-pointer border-b border-gray-300 dark:border-gray-600",style:{"font-size":"16px","text-align":"center",width:"100%","padding-bottom":"4px","white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis"},onClick:F=>te(p)},h(p.orderNo),9,wt))),128))])]),a("div",Ct,[a("div",Nt,[q(k,{"expanded-names":w.value,"onUpdate:expandedNames":r[2]||(r[2]=p=>w.value=p),accordion:""},{default:x(()=>[(I(!0),U(Y,null,Z(o.value,(p,le)=>(I(),H(R,{key:le,title:p.orderNo,name:p.orderNo,"title-style":{fontSize:"18px"}},{"header-extra":x(()=>[a("div",It,[St,a("span",Et,h(p.shelfedNumber)+" / "+h(p.number),1)])]),default:x(()=>[q(k,{value:i.value,"onUpdate:value":r[1]||(r[1]=F=>i.value=F),accordion:""},{default:x(()=>[(I(!0),U(Y,null,Z(p.children,(F,ue)=>(I(),H(R,{key:ue,title:F.name,name:ue},{header:x(()=>[O(h(F.name),1)]),"header-extra":x(()=>[a("div",Rt,[kt,a("span",Dt,h(F.shelfedNumber)+" / "+h(F.number),1)])]),default:x(()=>[q(k,{accordion:""},{default:x(()=>[(I(!0),U(Y,null,Z(F.children,(V,Ce)=>(I(),H(R,{key:Ce,title:V.rfid},{"header-extra":x(()=>[a("span",Pt,h(V.isShelfed===!0?V.number:""),1)]),default:x(()=>[a("div",Tt,[a("div",null,[$t,O(" "+h(V.name),1)]),a("div",null,[zt,O(" "+h(V.batch),1)]),a("div",null,[Bt,O(" "+h(V.productionDate),1)]),a("div",null,[Mt,O(" "+h(V.expiryDate),1)])])]),_:2},1032,["title"]))),128))]),_:2},1024)]),_:2},1032,["title","name"]))),128))]),_:2},1032,["value"])]),_:2},1032,["title","name"]))),128))]),_:1},8,["expanded-names"])]),a("div",At,[q(ee(ie),{type:"primary",onClick:ae,disabled:c.value.length<=0},{default:x(()=>[O("确认上架")]),_:1},8,["disabled"])])])]),q(pt,{"error-tags":M.value,onConfirm:ne},null,8,["error-tags"]),q(Je,{"model-value":z.value,"onUpdate:modelValue":r[3]||(r[3]=p=>z.value=p),"current-count":B.value},null,8,["model-value","current-count"])])}}});const Zt=at(Ft,[["__scopeId","data-v-040efaff"]]);export{Zt as default};
